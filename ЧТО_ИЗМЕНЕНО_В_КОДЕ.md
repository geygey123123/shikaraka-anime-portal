# üìù –ß–¢–û –ò–ó–ú–ï–ù–ï–ù–û –í –ö–û–î–ï

## üîß –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –§–ê–ô–õ–ê–•

---

### 1Ô∏è‚É£ `src/hooks/useAdmin.ts`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ: `useIsModerator` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏

**–ë–´–õ–û:**
```typescript
export const useIsModerator = (): boolean => {
  const { user } = useAuth();
  const { data: moderators } = useModerators();

  if (!user || !moderators) {
    return false;
  }

  return moderators.some(m => m.user_id === user.id);
};
```

**–°–¢–ê–õ–û:**
```typescript
export const useIsModerator = (): { isModerator: boolean; isLoading: boolean } => {
  const { user, loading: authLoading } = useAuth();
  const { data: moderators, isLoading: moderatorsLoading } = useModerators();

  if (authLoading || moderatorsLoading) {
    return { isModerator: false, isLoading: true };
  }

  if (!user || !moderators) {
    return { isModerator: false, isLoading: false };
  }

  return {
    isModerator: moderators.some(m => m.user_id === user.id),
    isLoading: false,
  };
};
```

**–ó–ê–ß–ï–ú:** –¢–µ–ø–µ—Ä—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.

---

### 2Ô∏è‚É£ `src/pages/ModerationPanel.tsx`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞

**–ë–´–õ–û:**
```typescript
const { isAdmin, isLoading: adminLoading } = useIsAdmin();
const isModerator = useIsModerator();

if (authLoading || adminLoading) {
  return <LoadingScreen />;
}

if (!user || (!isAdmin && !isModerator)) {
  navigate('/');
  return null;
}
```

**–°–¢–ê–õ–û:**
```typescript
const { isAdmin, isLoading: adminLoading } = useIsAdmin();
const { isModerator, isLoading: moderatorLoading } = useIsModerator();

if (authLoading || adminLoading || moderatorLoading) {
  return <LoadingScreen />;
}

if (!user || (!isAdmin && !isModerator)) {
  navigate('/');
  return null;
}
```

**–ó–ê–ß–ï–ú:** –¢–µ–ø–µ—Ä—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∂–¥–µ—Ç –ø–æ–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å—Ç–∞—Ç—É—Å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞, –∞ –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç —Å—Ä–∞–∑—É.

---

### 3Ô∏è‚É£ `src/components/comments/CommentModeration.tsx`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ: –£–±—Ä–∞–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã–π JOIN, –ø—Ä–æ—Ñ–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

**–ë–´–õ–û:**
```typescript
const { data, error } = await supabase
  .from('comments')
  .select(`
    *,
    profiles:user_id (username, avatar_url)
  `)
  .order('created_at', { ascending: false })
  .limit(50);
```

**–°–¢–ê–õ–û:**
```typescript
// –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
const { data: commentsData, error: commentsError } = await supabase
  .from('comments')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(50);

if (commentsError) throw commentsError;
if (!commentsData || commentsData.length === 0) return [];

// –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
const userIds = [...new Set(commentsData.map(c => c.user_id))];
const { data: profiles } = await supabase
  .from('profiles')
  .select('id, username, avatar_url')
  .in('id', userIds);

// –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
const profileMap = new Map(profiles?.map(p => [p.id, p]) || []);

return commentsData.map(comment => ({
  ...comment,
  profiles: profileMap.get(comment.user_id) || { username: null, avatar_url: null }
}));
```

**–ó–ê–ß–ï–ú:** –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Foreign Key –≤ –∑–∞–ø—Ä–æ—Å–µ. –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Å–≤—è–∑—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (–Ω–æ –ª—É—á—à–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å!).

---

### 4Ô∏è‚É£ `src/services/admin.service.ts`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Promise.allSettled` –≤–º–µ—Å—Ç–æ `Promise.all`

**–ë–´–õ–û:**
```typescript
const [totalUsers, activeUsers, ...] = await Promise.all([
  this.getTotalUsers(),
  this.getActiveUsers(),
  ...
]);

return { totalUsers, activeUsers, ... };
```

**–°–¢–ê–õ–û:**
```typescript
const [totalUsers, activeUsers, ...] = await Promise.allSettled([
  this.getTotalUsers(),
  this.getActiveUsers(),
  ...
]);

return {
  totalUsers: totalUsers.status === 'fulfilled' ? totalUsers.value : 0,
  activeUsers: activeUsers.status === 'fulfilled' ? activeUsers.value : 0,
  ...
};
```

**–ó–ê–ß–ï–ú:** –ï—Å–ª–∏ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –ø–∞–¥–∞–µ—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è. –ê–¥–º–∏–Ω–∫–∞ –ø–æ–∫–∞–∂–µ—Ç —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

---

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö

**–ë–´–õ–û:**
```typescript
private async getTotalUsers(): Promise<number> {
  const { count, error } = await supabase
    .from('profiles')
    .select('*', { count: 'exact', head: true });

  if (error) throw error;
  return count || 0;
}
```

**–°–¢–ê–õ–û:**
```typescript
private async getTotalUsers(): Promise<number> {
  try {
    const { count, error } = await supabase
      .from('profiles')
      .select('*', { count: 'exact', head: true });

    if (error) {
      console.error('Error getting total users:', error);
      return 0;
    }
    return count || 0;
  } catch (error) {
    console.error('Exception getting total users:', error);
    return 0;
  }
}
```

**–ó–ê–ß–ï–ú:** –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 0 –≤–º–µ—Å—Ç–æ –∫—Ä–∞—à–∞ –≤—Å–µ–π –∞–¥–º–∏–Ω–∫–∏.

---

## üóÑÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ë–ê–ó–ï –î–ê–ù–ù–´–•

### –§–∞–π–ª: `supabase/FIX_RELATIONSHIPS_AND_POLICIES.sql`

#### 1. –î–æ–±–∞–≤–ª–µ–Ω Foreign Key –¥–ª—è comments
```sql
ALTER TABLE public.comments
ADD CONSTRAINT comments_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES public.profiles(id)
ON DELETE CASCADE;
```

**–ó–ê–ß–ï–ú:** –¢–µ–ø–µ—Ä—å –±–∞–∑–∞ –∑–Ω–∞–µ—Ç —á—Ç–æ `comments.user_id` —Å–≤—è–∑–∞–Ω —Å `profiles.id`. –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É "Could not find a relationship".

---

#### 2. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã
```sql
CREATE INDEX IF NOT EXISTS idx_comments_user_id ON public.comments(user_id);
CREATE INDEX IF NOT EXISTS idx_comments_anime_id ON public.comments(anime_id);
CREATE INDEX IF NOT EXISTS idx_profiles_is_admin ON public.profiles(is_admin);
```

**–ó–ê–ß–ï–ú:** –£—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

---

#### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏
```sql
CREATE POLICY "Admins can view all comments"
ON public.comments FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND is_admin = true
  )
  OR user_id = auth.uid()
  OR is_deleted = false
);
```

**–ó–ê–ß–ï–ú:** –ê–¥–º–∏–Ω—ã —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –≤–∫–ª—é—á–∞—è —É–¥–∞–ª–µ–Ω–Ω—ã–µ.

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –î–û –ò –ü–û–°–õ–ï

### –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:
‚ùå –ú–æ–¥–µ—Ä–∞—Ü–∏—è: "Could not find a relationship between 'comments' and 'user_id'"
‚ùå –ê–¥–º–∏–Ω–∫–∞: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
‚ùå –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É
‚ùå –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞–¥–∞–µ—Ç –≤—Å—è –∞–¥–º–∏–Ω–∫–∞

### –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:
‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ `/moderation`
‚úÖ –ê–¥–º–∏–Ω–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üéØ –ò–¢–û–ì–û

**–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 4
**–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 1 (SQL —Å–∫—Ä–∏–ø—Ç)
**–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 5 —Ñ–∞–π–ª–æ–≤

**–í—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** ~10 –º–∏–Ω—É—Ç
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (–ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å)

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12):**
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ "Could not find a relationship"
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ "üìã Profile loaded: ‚úÖ ADMIN"

2. **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (/admin):**
   - –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ü–∏—Ñ—Ä—ã
   - –ù–µ—Ç –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏

3. **–ú–æ–¥–µ—Ä–∞—Ü–∏—è (/moderation):**
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase SQL):**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ Foreign Key
SELECT constraint_name FROM information_schema.table_constraints 
WHERE table_name = 'comments' AND constraint_name = 'comments_user_id_fkey';
-- –î–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∞

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT indexname FROM pg_indexes 
WHERE tablename = 'comments' AND indexname LIKE 'idx_%';
-- –î–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏–Ω–¥–µ–∫—Å—ã
```
