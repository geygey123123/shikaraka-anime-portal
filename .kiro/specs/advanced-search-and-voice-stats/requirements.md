# Requirements Document

## Introduction

Эта спецификация описывает улучшенную систему поиска аниме с тремя основными функциями: улучшенный поиск с группировкой связанных аниме, статистика озвучек с рекомендациями на основе выбора пользователей, и расширенная система фильтров. Система интегрируется с существующим React + TypeScript приложением, использующим Supabase для базы данных, Shikimori API для данных об аниме, и Kodik для видеоплеера.

## Glossary

- **Search_System**: Система поиска аниме, интегрированная с Shikimori API
- **Voice_Stats_System**: Система статистики и рекомендаций озвучек
- **Filter_System**: Система фильтрации результатов поиска
- **Shikimori_API**: Внешний API для получения данных об аниме
- **Kodik_Player**: Видеоплеер с поддержкой различных озвучек
- **Related_Anime**: Связанные аниме (сезоны, сиквелы, приквелы)
- **Voice_Track**: Озвучка аниме (например, Anilibria, AniDUB)
- **User_Voice_Selection**: Выбор озвучки пользователем для конкретного аниме
- **Database**: Supabase база данных для хранения пользовательских данных

## Requirements

### Requirement 1: Улучшенная система поиска

**User Story:** Как пользователь, я хочу получать правильно отсортированные результаты поиска с группировкой связанных аниме, чтобы легко находить нужное аниме и его сезоны в правильном порядке.

**Technical Note:** Shikimori API возвращает связанные аниме через отдельный запрос `/api/animes/{id}/related`. Поиск "Naruto" возвращает плоский список, группировка требует дополнительных запросов для каждого результата, что может привести к превышению лимитов API.

#### Acceptance Criteria

1. WHEN пользователь вводит поисковый запрос, THE Search_System SHALL отправить запрос к Shikimori_API и получить результаты
2. WHEN Search_System получает результаты от Shikimori_API, THE Search_System SHALL отсортировать результаты по релевантности
3. WHEN Search_System обрабатывает результаты, THE Search_System SHALL идентифицировать связанные аниме (сезоны, сиквелы, приквелы)
4. WHEN Search_System идентифицирует связанные аниме, THE Search_System SHALL сгруппировать их вместе
5. WHEN Search_System группирует связанные аниме, THE Search_System SHALL отсортировать их в хронологическом порядке (по дате выхода)
6. WHEN Search_System отображает сгруппированные аниме, THE Search_System SHALL показать основное аниме с возможностью раскрыть список связанных
7. WHEN пользователь раскрывает группу связанных аниме, THE Search_System SHALL загрузить связанные аниме через `/api/animes/{id}/related` только для этой группы
8. THE Search_System SHALL использовать ленивую загрузку связанных аниме для оптимизации запросов к Shikimori_API и избежания превышения лимитов
9. WHERE Shikimori_API предоставляет GraphQL endpoint, THE Search_System SHALL использовать GraphQL для получения вложенных данных о связанных аниме в одном запросе
10. THE Search_System SHALL кэшировать результаты поиска для улучшения производительности

### Requirement 2: Статистика озвучек с рекомендациями

**User Story:** Как пользователь, я хочу видеть статистику выбора озвучек другими пользователями, чтобы выбрать наиболее популярную и качественную озвучку для просмотра.

**Technical Note:** Kodik является iframe плеером. Отслеживание выбора озвучки требует использования postMessage API из-за политик Cross-Origin. Плеер Kodik отправляет события через window.postMessage при изменении озвучки.

#### Acceptance Criteria

1. WHEN пользователь открывает страницу аниме, THE Voice_Stats_System SHALL отобразить надпись "Какую озвучку выбрать?" над видеоплеером
2. WHEN пользователь наводит курсор на надпись "Какую озвучку выбрать?", THE Voice_Stats_System SHALL показать всплывающее окно со статистикой озвучек
3. WHEN Voice_Stats_System отображает статистику, THE Voice_Stats_System SHALL показать список озвучек, отсортированных по популярности (от наиболее выбираемой к наименее выбираемой)
4. WHEN Voice_Stats_System отображает статистику, THE Voice_Stats_System SHALL показать процент или количество пользователей, выбравших каждую озвучку
5. THE Voice_Stats_System SHALL слушать события postMessage от Kodik iframe для обнаружения изменений озвучки
6. WHEN пользователь выбирает озвучку в Kodik_Player, THE Voice_Stats_System SHALL записать выбор в Database с привязкой к конкретному аниме и пользователю
7. WHEN пользователь начинает просмотр с выбранной озвучкой, THE Voice_Stats_System SHALL увеличить счетчик просмотров для этой озвучки
8. THE Voice_Stats_System SHALL хранить статистику индивидуально для каждого аниме
9. WHEN пользователь не авторизован, THE Voice_Stats_System SHALL показывать статистику, но не записывать выбор пользователя

### Requirement 3: Поиск аниме по фильтрам

**User Story:** Как пользователь, я хочу фильтровать результаты поиска по различным критериям, чтобы быстро находить аниме, соответствующее моим предпочтениям.

#### Acceptance Criteria

1. WHEN пользователь открывает страницу поиска, THE Filter_System SHALL отобразить панель фильтров
2. THE Filter_System SHALL предоставить фильтр по жанрам с возможностью выбора нескольких жанров
3. THE Filter_System SHALL предоставить фильтр по году выпуска с возможностью указания диапазона
4. THE Filter_System SHALL предоставить фильтр по типу аниме (TV, фильм, OVA, ONA, Special)
5. THE Filter_System SHALL предоставить фильтр по статусу (онгоинг, завершено, анонсировано)
6. WHEN пользователь выбирает фильтры, THE Filter_System SHALL применить их к результатам поиска
7. WHEN пользователь выбирает несколько фильтров, THE Filter_System SHALL применить их комбинацию (логическое И)
8. WHEN Filter_System применяет фильтры, THE Filter_System SHALL отправить запрос к Shikimori_API с параметрами фильтрации
9. WHEN пользователь очищает фильтры, THE Filter_System SHALL сбросить все выбранные фильтры и показать все результаты
10. THE Filter_System SHALL сохранять выбранные фильтры в URL для возможности поделиться ссылкой

### Requirement 4: Интеграция с существующей системой

**User Story:** Как разработчик, я хочу интегрировать новые функции с существующей кодовой базой, чтобы обеспечить совместимость и не нарушить работу текущих функций.

#### Acceptance Criteria

1. THE Search_System SHALL использовать существующий Shikimori API клиент для запросов
2. THE Voice_Stats_System SHALL использовать существующее Supabase подключение для работы с Database
3. THE Voice_Stats_System SHALL интегрироваться с существующим Kodik_Player без изменения его основной функциональности
4. WHEN новые функции добавляются, THE System SHALL сохранить работоспособность существующих функций (избранное, рейтинги, комментарии)
5. THE System SHALL использовать существующую систему аутентификации для определения авторизованных пользователей
6. THE System SHALL следовать существующим паттернам кода (React hooks, TypeScript типы, компонентная архитектура)

### Requirement 5: Производительность и оптимизация

**User Story:** Как пользователь, я хочу, чтобы поиск и загрузка статистики работали быстро, чтобы не ждать долго при взаимодействии с системой.

#### Acceptance Criteria

1. WHEN Search_System выполняет поиск, THE Search_System SHALL возвращать результаты в течение 2 секунд
2. WHEN Voice_Stats_System загружает статистику, THE Voice_Stats_System SHALL отобразить данные в течение 1 секунды
3. THE Search_System SHALL использовать debounce для поисковых запросов с задержкой 300ms
4. THE Voice_Stats_System SHALL кэшировать статистику озвучек на стороне клиента на 5 минут
5. WHEN Filter_System применяет фильтры, THE Filter_System SHALL обновить результаты в течение 2 секунд
6. THE System SHALL использовать пагинацию для отображения результатов поиска (20 результатов на страницу)

### Requirement 6: Хранение данных

**User Story:** Как система, я должна правильно хранить данные о выборе озвучек пользователями, чтобы обеспечить точную статистику и рекомендации.

**Technical Note:** Данные хранятся в Supabase. Таблица `voice_stats` содержит информацию о выборе озвучек пользователями для каждого аниме.

#### Database Schema

**Таблица: `voice_stats`**

| Column      | Type      | Constraints                                              | Notes                                                    |
|-------------|-----------|----------------------------------------------------------|----------------------------------------------------------|
| id          | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()                   | Уникальный идентификатор записи                          |
| user_id     | uuid      | FOREIGN KEY REFERENCES auth.users(id), NULLABLE          | ID пользователя (nullable для анонимных пользователей)   |
| anime_id    | int4      | NOT NULL                                                 | ID аниме из Shikimori                                    |
| voice_name  | text      | NOT NULL                                                 | Название студии озвучки (Anilibria, AniDUB, и т.д.)      |
| updated_at  | timestamp | DEFAULT now()                                            | Время последнего обновления для отслеживания актуальности|

**Индексы:**
- `idx_voice_stats_anime_id` на `anime_id` для быстрого получения статистики по аниме
- `idx_voice_stats_user_anime` на `(user_id, anime_id)` для быстрого поиска выбора пользователя
- `idx_voice_stats_voice_name` на `voice_name` для агрегации по озвучкам

**RLS Policies:**
- SELECT: доступно всем (для отображения статистики)
- INSERT/UPDATE: только для авторизованных пользователей
- DELETE: только для владельца записи или администратора

#### Acceptance Criteria

1. THE Database SHALL содержать таблицу `voice_stats` со структурой, описанной выше
2. WHEN пользователь выбирает озвучку, THE Voice_Stats_System SHALL записать запись с полями: id, user_id, anime_id, voice_name, updated_at
3. THE Database SHALL обеспечить уникальность записи по комбинации (user_id, anime_id) через UNIQUE constraint
4. WHEN пользователь меняет озвучку для того же аниме, THE Voice_Stats_System SHALL обновить существующую запись (UPDATE) вместо создания новой
5. THE Database SHALL иметь индексы на поля anime_id, (user_id, anime_id), и voice_name для быстрого получения статистики
6. THE Voice_Stats_System SHALL агрегировать данные для получения статистики по каждому аниме через SQL запросы с GROUP BY
7. WHEN анонимный пользователь просматривает статистику, THE Voice_Stats_System SHALL получить агрегированные данные без фильтрации по user_id

### Requirement 7: Пользовательский интерфейс

**User Story:** Как пользователь, я хочу иметь интуитивно понятный и удобный интерфейс для поиска и просмотра статистики, чтобы легко взаимодействовать с системой.

#### Acceptance Criteria

1. WHEN пользователь вводит текст в поисковую строку, THE Search_System SHALL показывать индикатор загрузки во время поиска
2. WHEN Search_System отображает результаты, THE Search_System SHALL показывать постер, название, год и рейтинг для каждого аниме
3. WHEN Search_System отображает сгруппированные аниме, THE Search_System SHALL использовать визуальное отличие (иконка или отступ) для связанных аниме
4. WHEN Voice_Stats_System отображает статистику, THE Voice_Stats_System SHALL использовать прогресс-бары или проценты для визуализации популярности
5. WHEN Filter_System отображает фильтры, THE Filter_System SHALL использовать чекбоксы для множественного выбора и дропдауны для одиночного выбора
6. THE System SHALL быть адаптивным и корректно отображаться на мобильных устройствах
7. WHEN пользователь взаимодействует с элементами интерфейса, THE System SHALL предоставлять визуальную обратную связь (hover эффекты, анимации)
