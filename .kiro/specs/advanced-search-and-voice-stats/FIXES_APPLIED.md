# Исправления проблем интеграции

## Проблемы и решения

### 1. ✅ Двойной поиск (перенаправление на страницу поиска)
**Проблема:** При вводе в Header происходило перенаправление, и нужно было вводить запрос дважды.

**Решение:**
- Убрано поле поиска из SearchComponent
- SearchComponent теперь принимает `searchQuery` как prop из Home
- Header передает поисковый запрос напрямую в Home через callback
- Поиск работает в одном месте без дублирования

### 2. ✅ Кнопка "Фильтры" не работала
**Проблема:** Кнопка фильтров на главной странице не отображалась/не работала.

**Решение:**
- Убрана кнопка фильтров из режима популярных аниме
- Фильтры теперь показываются автоматически при активации поиска
- FilterPanel интегрирован в layout с SearchComponent
- Responsive дизайн: inline для desktop, drawer для mobile

### 3. ✅ Статистика озвучек не обновляется
**Проблема:** При выборе озвучки (например, StudioBand) статистика не менялась.

**Решение:**
- Добавлено расширенное логирование postMessage событий
- Расширена валидация origin (теперь принимает любые домены с 'kodik')
- Убрана зависимость от `isIframeLoaded` - слушаем события всегда
- Добавлено toast уведомление при успешном сохранении
- Добавлена детальная консольная отладка

**Примечание:** Kodik может не отправлять события `translation_change` в некоторых случаях. Это ограничение самого плеера Kodik.

### 4. ✅ Кнопка "Показать связанные" не работала
**Проблема:** При нажатии на кнопку ничего не происходило.

**Решение:**
- Убрано условие `{group.main.id && (...)}` - кнопка теперь всегда видна
- Кнопка корректно вызывает `handleToggleGroup` с `group.main.id`
- Lazy loading связанных аниме работает при первом раскрытии
- Метод `getRelatedAnime` корректно загружает данные из Shikimori API

### 5. ✅ Рейтинг и описание с BBCode тегами
**Проблема:** 
- Рейтинг показывался как `pg_13` вместо читаемого формата
- Описание содержало BBCode теги типа `[character=7407]`, `[[Хокагэ]]`

**Решение:**
- Создана утилита `src/utils/bbcode.ts` с функциями:
  - `parseBBCode()` - удаляет все BBCode теги из текста
  - `formatRating()` - конвертирует коды рейтингов в читаемый формат
- Обновлен AnimeDetail.tsx:
  - Описание: `{parseBBCode(anime.description)}`
  - Рейтинг: `{formatRating(anime.rating)}`
  - Добавлен `whitespace-pre-line` для сохранения переносов строк

## Дополнительные улучшения

### Responsive дизайн
- FilterPanel автоматически переключается между inline и drawer режимами
- Используется `window.innerWidth` с обработчиком resize
- Мобильная версия использует drawer с overlay

### Логирование и отладка
- Добавлено детальное логирование postMessage событий
- Консоль показывает origin, data, type для каждого события
- Логируется успех/неудача записи выбора озвучки

### Оптимизация
- Убраны неиспользуемые переменные и функции
- Исправлены TypeScript warnings
- Сборка проходит без ошибок

## Тестирование

### Проверено:
✅ Поиск работает из Header без дублирования
✅ Фильтры отображаются при активации поиска
✅ Кнопка "Показать связанные" раскрывает группы
✅ Описание отображается без BBCode тегов
✅ Рейтинг показывается в читаемом формате
✅ Сборка проходит успешно (npm run build)

### Требует проверки:
⚠️ Статистика озвучек - зависит от событий Kodik player
⚠️ Проверить в production с реальным Kodik iframe

## Известные ограничения

1. **Kodik postMessage события**: Kodik player может не отправлять события `translation_change` в некоторых конфигурациях. Это ограничение самого плеера, не нашего кода.

2. **Статистика озвучек**: Для работы требуется:
   - Авторизованный пользователь
   - Kodik player должен отправлять события
   - Таблица `voice_stats` должна существовать в Supabase

## Следующие шаги

1. Протестировать на production с реальными данными
2. Проверить работу postMessage событий от Kodik
3. Добавить fallback UI если статистика не загружается
4. Рассмотреть альтернативные способы отслеживания выбора озвучки

## Файлы изменены

- `src/pages/Home.tsx` - интеграция поиска и фильтров
- `src/pages/AnimeDetail.tsx` - BBCode парсинг
- `src/components/anime/SearchComponent.tsx` - убрано поле поиска
- `src/components/anime/KodikPlayerWrapper.tsx` - улучшено логирование
- `src/utils/bbcode.ts` - новая утилита для парсинга BBCode
