# Исправление переключения "Показать/Скрыть связанные"

## Проблема

После последовательности действий:
1. Нажать "Показать связанные" на аниме (например, "Маг битва")
2. Нажать "Скрыть связанные" на том же аниме
3. Снова нажать "Показать связанные" на том же аниме

Кнопка не работала - связанные аниме не показывались. Приходилось нажимать на другое аниме, чтобы потом вернуться к первому.

## Причина

Проблема была в логике управления состоянием `expandedGroups`:

```typescript
// Старая логика:
const expandGroup = useCallback(
  async (animeId: number) => {
    if (expandedGroups.has(animeId)) {
      return; // ❌ Сразу выходим если ID уже в Set
    }
    // ... загрузка данных
    setExpandedGroups((prev) => new Set(prev).add(animeId));
  },
  [expandedGroups, ...]
);
```

**Что происходило:**
1. При первом "Показать" → ID добавляется в `expandedGroups`
2. При "Скрыть" → ID **оставался** в `expandedGroups` (не удалялся!)
3. При повторном "Показать" → `expandGroup` видел ID в Set и сразу выходил

## Решение

Добавлена логика удаления ID из `expandedGroups` при закрытии группы:

```typescript
const toggleGroup = useCallback(
  async (animeId: number) => {
    // ... получение данных
    
    const newIsExpanded = !group.isExpanded;

    // ✅ Если закрываем - убираем из expandedGroups
    if (!newIsExpanded) {
      setExpandedGroups((prev) => {
        const next = new Set(prev);
        next.delete(animeId);
        return next;
      });
    }

    // Если раскрываем и еще не загружали связанные аниме
    if (newIsExpanded && group.related.length === 0) {
      await expandGroup(animeId);
    } else {
      // Просто переключаем состояние
      queryClient.setQueryData(...);
    }
  },
  [...]
);
```

## Дополнительно: Убраны логи

Убраны все `console.log` которые спамили в консоль:
- `[expandGroup] Loading related anime for ID: ...`
- `[expandGroup] Found X related anime: ...`
- `[Shikimori] Fetching related anime for ID: ...`
- `[Shikimori] Related anime response for ...`
- `[Shikimori] Filtered X anime from Y total items`
- `[Shikimori] Skipping non-anime item: ...`

Оставлен только один лог для критических ошибок:
- `[expandGroup] Failed to load related anime: ...` (только при ошибке)

## Как это работает теперь

### Первое раскрытие:
1. **Клик** → "Показать связанные"
2. **Проверка** → `expandedGroups` не содержит ID
3. **Загрузка** → API запрос к Shikimori
4. **Добавление** → ID добавляется в `expandedGroups`
5. **Отображение** → Связанные аниме показываются

### Закрытие:
1. **Клик** → "Скрыть связанные"
2. **Удаление** → ID удаляется из `expandedGroups` ✅
3. **Отображение** → Связанные аниме скрываются

### Повторное раскрытие:
1. **Клик** → "Показать связанные"
2. **Проверка** → `expandedGroups` не содержит ID (был удален!)
3. **Использование кэша** → Данные уже есть в `group.related`
4. **Отображение** → Связанные аниме показываются мгновенно

## Тестирование

### Проверьте:

1. **Найдите аниме** (например, "Naruto")
2. **Нажмите "Показать связанные"**
   - Должны появиться связанные аниме
3. **Нажмите "Скрыть связанные"**
   - Связанные аниме должны скрыться
4. **Снова нажмите "Показать связанные"**
   - ✅ Связанные аниме должны появиться мгновенно
   - ✅ Кнопка должна работать без проблем
5. **Повторите несколько раз**
   - Переключение должно работать плавно

### Проверьте консоль:
- Откройте DevTools (F12)
- Консоль должна быть чистой (без спама логов)
- Только ошибки (если есть) будут показаны

## Файлы изменены

- `src/hooks/useSearch.ts` - добавлено удаление из `expandedGroups` при закрытии, убраны логи
- `src/services/shikimori.ts` - убраны все console.log

## Сборка

✅ Сборка успешна без ошибок
✅ TypeScript проверки пройдены
✅ Все предупреждения исправлены

## Статус

✅ **ИСПРАВЛЕНО** - Переключение "Показать/Скрыть связанные" работает корректно
✅ **ОЧИЩЕНО** - Убран спам логов в консоль
